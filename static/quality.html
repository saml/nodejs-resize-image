<!doctype html>
<meta charset="utf-8">
<title>Image Quality Curve</title>
<style>
#curve {
  border: 1px solid black;
}
</style>
<canvas id="curve"></canvas>
<div id="curve-stat"></div>
<div id="container">
</div>
<script src="utils.js"></script>
<script>
function getBezierFor(t, p0, p1, p2, p3) {
  var i = 1-t;
  
  p0 = i*p0 + t*p1;
  p1 = i*p1 + t*p2;
  p2 = i*p2 + t*p3;

  p0 = i*p0 + t*p1;
  p1 = i*p1 + t*p2;
  
  return i*p0 + t*p1;
}

function drawBezier(ctx, p0, p1, p2, p3, interval) {
  interval = interval || 0.1;

  var p0x = p0.x;
  var p0y = p0.y;
  var p1x = p1.x;
  var p1y = p1.y;
  var p2x = p2.x;
  var p2y = p2.y;
  var p3x = p3.x;
  var p3y = p3.y;

  ctx.moveTo(p0.x, p0.y);
  for (var i = 0; i < 1; i += interval) {
    var x = getBezierFor(i, p0x, p1x, p2x, p3x);
    var y = getBezierFor(i, p0y, p1y, p2y, p3y);
    ctx.lineTo(x, y);
  }
  ctx.stroke();
}

function drawControlPoint(ctx, p, radius) {
  radius = radius || 5;
  ctx.rect(p.x-radius, p.y-radius, radius*2, radius*2);
  ctx.stroke();
}

function Point(x,y) {
  return {x:x,y:y};
}


function BezierGraph(canvas, output, p0, p1, p2, p3) {
  var ctx = canvas.getContext('2d');
  var points = [p0, p1, p2, p3];
  var bound = canvas.getBoundingClientRect();
  var radius = 10;

  var pointBeingDragged = null;


  function findPointAt(x, y) {
    var arr = points.filter(function(p) {
      var left = p.x - radius;
      var right = p.x + radius;
      var ceil = p.y - radius;
      var floor = p.y + radius;

      return x > left && x < right && y < floor && y > ceil;
    });
    if (arr.length === 0) {
      return null;
    }
    return arr[0];//first point
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();

    points.forEach(function(p) {
      drawControlPoint(ctx, p, radius);    
    });

    drawBezier(ctx, p0, p1, p2, p3, 0.05);
  }

  canvas.addEventListener('mousedown', function(evt) {
    var x = evt.clientX - bound.left;
    var y = evt.clientY - bound.top;

    var p = findPointAt(x,y);
    if (p) {
      pointBeingDragged = p;
    }
  });

  canvas.addEventListener('mouseup', function(evt) {
    pointBeingDragged = null;
  });

  canvas.addEventListener('mousemove', function(evt) {
    var x = evt.clientX - bound.left;
    var y = evt.clientY - bound.top;
    
    output.innerHTML = x+','+y;

    if (pointBeingDragged) {
      pointBeingDragged.x = x;
      pointBeingDragged.y = y;
      draw();
    }
  });

  draw();

}

var canvas = document.getElementById('curve');
canvas.width = 300;
canvas.height = 300;

var p0 = Point(20,20);
var p1 = Point(100,100);
var p2 = Point(200,200);
var p3 = Point(280,280);

var canvasStat = document.getElementById('curve-stat');

var graph = BezierGraph(canvas, canvasStat, p0, p1, p2, p3);

</script>
