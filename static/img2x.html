<!doctype html>
<meta charset="utf-8">
<title>Image Quality Test</title>
<style>
img {
  width: 100%;
}
</style>
<div id="container">
</div>
<script src="utils.js"></script>
<script>
function appendImage(cellWidth, cellHeight, rendition, url, parentElem) {
  var cell = document.createElement('div');
  cell.className = 'cell';
  cell.style.width = cellWidth + 'px';

  function append(img, size) {

    img.addEventListener('load', function() {
      var kb = toKilobyte(size);
      cell.appendChild(document.createElement('br'));

      var msg = img.naturalWidth+'x'+img.naturalHeight+' | q'+rendition.quality+' | '+kb+'kb';
      cell.appendChild(document.createTextNode(msg));
      cell.appendChild(document.createElement('br'));

      cell.appendChild(createAnchor(url));

    });


    cell.appendChild(img);
  }


  parentElem.appendChild(cell);
  loadImage(url, append);
}

function parseRenditions(str) {
  var renditions = [];
  if (!str) {
    return renditions;
  }

  var regex = /^(\d+)q?(\d+)?$/;
  str.split(',').forEach(function(x) {
    var m = regex.exec(x);
    if (m) {
      var size = parseInt(m[1], 10);
      var quality = parseInt(m[2], 10);
      renditions.push({size: size, quality: quality});
    }
  });
  return renditions;
}

var query = parseQueryString();
var url = query.url;


var cellWidth = parseInt(query.w, 10) || 300;
var cellHeight = parseInt(query.h, 10) || 300;
var renditions = parseRenditions(query.r);

var container = document.getElementById('container');

renditions.forEach(function(rendition) {
  var renditionHeight = rendition.size * cellHeight/cellWidth;
  var renditionUrl = getRendition(url, rendition.size, renditionHeight, false, rendition.quality);
  
  appendImage(cellWidth, cellHeight, rendition, renditionUrl, container);
});
</script>

