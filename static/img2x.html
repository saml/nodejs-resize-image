<!doctype html>
<meta charset="utf-8">
<title>Image Quality Test</title>
<style>
#container {
  display: flex;
}
#img { 
  width: 30%;
  float: left; 
  text-align: center;
}
#img-2x { 
  width: 30%;
  display: inline-block;
  text-align: center;
}
#img-x2 {
  width: 30%;
  float: right; 
  text-align: center;
}
img {
  width: 100%;
}
</style>
<div id="container">
  <div id="img"></div>
  <div id="img-2x"></div>
  <div id="img-x2"></div>
</div>
<script>
function parseQueryString(query) {
  query = query || window.location.search.substring(1);

  var args = {};
  query.split(/&/).forEach(function(kv) {
    var splitted = kv.split(/=/);
    args[splitted[0]] = splitted[1];
  });
  return args;
}

function parseAssetUrl(url) {
  var regex = new RegExp('^(.+)(\\.\\w+)$');
  var m = regex.exec(url);
  return m;
}

function getRendition(url, width, height, isNoCrop, quality) {
  var parsed = parseAssetUrl(url);
  if (!parsed) {
    return null;
  }


  var withoutExt = parsed[1];
  var ext = parsed[2];

  var args = [];
  if (!isNaN(width) && !isNaN(height)) {
    var dimension = width+'x'+height;
    if (isNoCrop) {
      dimension += 't';
    }
    args.push(dimension);
  }

  if (!isNaN(quality)) {
    args.push('q'+quality);
  }

  return '/'+withoutExt+'.'+args.join('.')+ext;
}

function createAnchor(url, text) {
  var a = document.createElement('a');
  a.href = url;
  a.innerHTML = text || url;
  return a;
}


function appendImage(url, parentElem) {
  function append(img, size) {
    img.addEventListener('load', function() {
      var kb = toKilobyte(size);
      parentElem.appendChild(img);
      parentElem.appendChild(document.createElement('br'));

      var msg = img.naturalWidth+'x'+img.naturalHeight+' | '+img.clientWidth+'x'+img.clientHeight+' | '+kb+'kb';
      parentElem.appendChild(document.createTextNode(msg));
      parentElem.appendChild(document.createElement('br'));

      parentElem.appendChild(createAnchor(url));
    });
  }

  loadImage(url, append);
}

function toKilobyte(size) {
  var kilobytes = size / Math.pow(2, 10);
  var digits = Math.log(kilobytes) / Math.LN10 + 1;
  return kilobytes.toPrecision(digits+2);
}

function loadImage(url, onSuccess) {
  var xhr = new XMLHttpRequest();
  xhr.responseType = 'blob';

  xhr.addEventListener('load', function() {
    var blob = xhr.response;

    var reader = new FileReader();
    reader.addEventListener('loadend', function() {
      var blobBase64 = reader.result;
      var img = new Image();
      img.src = blobBase64;
      if (typeof onSuccess == 'function') {
        var size = parseInt(xhr.getResponseHeader('Content-Length'), 10) || blob.size;
        onSuccess(img, size);
      }
    });

    reader.readAsDataURL(xhr.response);
  });
  xhr.open('GET', url);
  xhr.send();
}


var query = parseQueryString();
var url = query.url;
var width = parseInt(query.width, 10) || 200;
var height = parseInt(query.height, 10) || 200;

appendImage(getRendition(url, width, height, false, 20), document.getElementById('img'));
appendImage(getRendition(url, width, height, false, 30), document.getElementById('img-2x'));
appendImage(getRendition(url, width, height, false, 50), document.getElementById('img-x2'));
</script>

